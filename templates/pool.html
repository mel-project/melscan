{% extends "skeleton.html" %}

{% block title %} Melscan {% endblock %}

{% block head %}
<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.js"></script>
<style>
  #head button {
    font-size: 90%;
    margin-left: 4px;
    margin-right: 4px;
    border: #ccc;
    border-width: 1px;
    border-style: solid;
    padding-left: 4px;
    padding-right: 4px;
    border-radius: 10%;
  }

  #head button:hover {
    background-color: #eee;
  }

  .card {
    border: #ccc;
    border-width: 1px;
    border-style: solid;
    padding-left: 4px;
    padding-right: 4px;
    border-radius: 8px;
    margin: 4px;
    padding: 16px;
  }

  .ticker-card {
    display: flex;

    justify-content: center;
    flex-direction: column;
  }
</style>
{% endblock %}

{% block nav %}
<a href="/" class="text-black hover:text-opacity-60 hover:underline">Melscan</a>
{% endblock %}


{% block body %}
<div class="container mx-auto max-w-screen-lg">
  <div class="mb-3 mt-8">
    <h3 class="text-2xl font-bold">Token {{denom}}</h3>
  </div>

  <div class="grid grid-cols-12 md:grid-flow-col grid-flow-row">
    <div class="col-span-12 md:col-span-3 card ticker-card">
      <div><small>Price</small></div>
      <div class="text-lg font-medium">{{(last_item.price * 1000.0).round() / 1000.0}} mel/{{denom}}</div>
    </div>
    <div class="col-span-12 md:col-span-3 card ticker-card">
      <div><small>Liquidity</small>
        <div class="tooltip">
          <div class="info-cirlce">
            <div class="info-i">i</div>
            <div class="tooltiptext">This is the tip text</div>
          </div>
        </div>
      </div>
      <div class="text-lg font-medium">{{(last_item.liquidity * 1000.0).round() / 1000.0}} mel</div>
    </div>
    <div class="col-span-12 md:col-span-3 card ticker-card">
      <div><small>Current height</small></div>
      <div class="text-lg font-medium">{{last_item.height}}</div>
    </div>

    <div class="md:col-span-9 col-span-12 md:row-span-3 card">
      <div class="grid grid-cols-2" id="head">
        <div class="text-left"><button onclick="loadLiquidity()">Liquidity</button><button
            onclick="loadPrice()">Price</button></div>
        <div class="text-right"><button onclick="loadLastDay()">1D</button><button
            onclick="loadLastWeek()">1W</button><button onclick="loadLastMonth()">1M</button><button
            onclick="loadAllTime()">All</button></div>
      </div>
      <canvas id="myChart" width="400" height="400"></canvas>

    </div>

  </div>


</div>
<script>
  var denom = {{ denom|json}}
  var last_item = {{ last_item|json}}
</script>
<script>
async function createChart() {
    const formatter = new Intl.DateTimeFormat('en', { month: 'long' });
    var ctx = document.getElementById('myChart').getContext('2d');
    console.log(denom);
    console.log(`/raw/pool-data-batch/${denom}/0/${last_item.height}`)
    var pooldata = await $.ajax(`/raw/pool-data-batch/${denom}/0/${last_item.height}`)
    var labels = pooldata.map(i => formatter.format(new Date(i.date)));
    var last = "";
    console.info(pooldata)
    var myChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: `MEL/${denom} liquidity`,
          data: pooldata.map(i => i.liquidity ),
          fill: 'origin',
          borderWidth: 1
        }],
      },
        options: {
          // xAxis: {
          //   type: "time"
          // },
          scales: {
            x: {
              ticks: {
                    // Include a dollar sign in the ticks
                    callback: function(value, index, values) {
                        // console.log(labels[index])
                        if(labels[index] == last){
                          return null
                        }
                        else{
                          console.log("new label", labels[index])
                          last = labels[index]
                        }
                        return last;
                    }
                }
            }
        }
      }
    }
    )

  return myChart
}
var chart = createChart()

</script>

{% endblock %}